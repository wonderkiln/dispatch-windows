name: Distribute

on:
  push:
    branches: [develop, beta, master]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v2

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v1

      - name: Restore NuGet Packages
        run: nuget restore Dispatch\Dispatch.sln

      - name: Build the Solution (Develop)
        if: github.ref == 'refs/heads/develop'
        run: msbuild Dispatch\Dispatch.sln /p:Configuration=Release /p:Revision=${{ github.run_number }} /p:DefineConstants=NIGHTLY

      - name: Build the Solution (Beta)
        if: github.ref == 'refs/heads/beta'
        run: msbuild Dispatch\Dispatch.sln /p:Configuration=Release /p:Revision=${{ github.run_number }} /p:DefineConstants=BETA

      - name: Build the Solution (Master)
        if: github.ref == 'refs/heads/master'
        run: msbuild Dispatch\Dispatch.sln /p:Configuration=Release /p:Revision=${{ github.run_number }}

      - name: Install Inno Setup
        run: choco install -y innosetup

      - name: Package Setup
        run: iscc Setup\script.iss

      - name: Archive Setup
        uses: actions/upload-artifact@v2
        with:
          name: setup
          path: Setup\Output\

  upload:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download Setup
        uses: actions/download-artifact@v2
        with:
          name: setup

      - name: Set Container Name (Develop)
        if: github.ref == 'refs/heads/develop'
        run: echo 'CONTAINER_NAME=nightly' >> $GITHUB_ENV

      - name: Set Container Name (Beta)
        if: github.ref == 'refs/heads/beta'
        run: echo 'CONTAINER_NAME=beta' >> $GITHUB_ENV

      - name: Set Container Name (Master)
        if: github.ref == 'refs/heads/master'
        run: echo 'CONTAINER_NAME=stable' >> $GITHUB_ENV

      - name: Upload to Azure
        uses: LanceMcCarthy/Action-AzureBlobUpload@v1.7.1
        if: github.ref == 'refs/heads/develop'
        with:
          connection_string: ${{ secrets.AZURE_CONNECTION_STRING }}
          container_name: ${{ env.CONTAINER_NAME }}
          source_folder: .

      - name: Notify the API
        run: |
          NAME=$(ls | grep '.exe' | head -1)
          VERSION=$(echo $NAME | egrep -o '[0-9]+.[0-9]+.[0-9]+.[0-9]+')
          URL="https://stwonderkilnprod.blob.core.windows.net/${{ env.CONTAINER_NAME }}/$NAME"
          FORMAT='{ "url": "%s", "version": "%s" }\n'
          JSON=$(printf "$FORMAT" "$URL" "$VERSION")
          echo $JSON
